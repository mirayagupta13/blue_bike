---
title: "BlueBikesProject"
output: html_document
date: "2024-11-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r including_packages, include=FALSE}
#including packages
library(dplyr)
library(purrr)
library(readr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(plotly)
library(scales)
library(sinaplot)
library(RColorBrewer)
library(scales)
library(ggridges)
library(leaflet)
```

#Loading data
```{r, include=FALSE}
setwd('/Users/mirayagupta/Desktop/DS104/bb2023')
csv_file_list = dir()
csv_file_list
df_list = map(csv_file_list, read_csv)
data = bind_rows(df_list)
```

#Exploring data
```{r explore_data}
dim(data)
colnames(data)
```

#Handling missing values
```{r missing_values}
sum(is.na(data$tripduration)) #less than 10% of data
sum(is.na(data$`start station id`)) #less than 10% of data
sum(is.na(data$`end_lat`))

# Get row indices where cols are NA
no_tripdur_indices = which(is.na(data$tripduration))
no_startid_indices = which(is.na(data$`start station id`))

identical(no_tripdur_indices, no_startid_indices)
# Drop these rows 
data = data %>% slice(-no_tripdur_indices)
sum(is.na(data$tripduration))

#check if i can impute was it a cwrtain month? 
```

#Exploring bikeid variable
```{r explore_bikeid}
sum(is.na(data$bikeid)) #no missing values
length(unique(data$bikeid)) #5005
dim(data) # 2999792   
range(data$bikeid)
```

#Adding columns with more information on month, season, etc.
```{r add_data}
data$tripduration = data$tripduration / 60 #converting sec to min
data$month = month(data$starttime)
data$day_of_week = wday(data$starttime)
```

```{r}
data = data %>%
  mutate(season = case_when(
      month %in% c(12, 1, 2) ~ "Winter",
      month %in% c(3, 4, 5) ~ "Spring",
      month %in% c(6, 7, 8) ~ "Summer",
      month %in% c(9, 10, 11) ~ "Fall"))
```

```{r}
#simplified metric, not showing how many bikes are in use at any point in time but how many rides were started in that hour
data = data[, !names(data) %in% "---"]
data = data %>%
  mutate(
    starttime = ymd_hms(starttime),
    stoptime = ymd_hms(stoptime)
  )
data$starthour = hour(data$starttime)
data$startday = as.Date(data$starttime)
```

```{r}
time_frame = seq(from = ymd_hms('2023-03-01 00:00:00'), 
                  to = ymd_hms('2023-03-01 23:59:59'), 
                  by = 'hour')

bikes_in_use = data.frame(time = time_frame, bikes_in_use = 0)

for (i in 1:nrow(bikes_in_use)) {
  count = nrow(data %>%
    filter(starttime <= bikes_in_use$time[i] & stoptime >= bikes_in_use$time[i]))
  bikes_in_use$bikes_in_use[i] = count
}

# Print the results
print(bikes_in_use)
plot(bikes_in_use$time, bikes_in_use$bikes_in_use, main='Number of bikes in use at every hour, Mar 1 2023')
```

```{r}
hourly_bike_usage = data.frame(hour = 0:23, avg_bikes_in_use = 0, med_bikes_in_use = 0, month = 0, day = 0, count_electric = 0)

for (h in 0:23) {
  # Filter data by hour
  count_per_hour = data %>%
    filter(hour(starttime) <= h & hour(stoptime) >= h) %>%
    summarise(avg_bikes = mean(n()))
  
  #QUESTION: IS AVERAGE THE BEST SUMMARY STATISTIC TO USE HERE? 
  hourly_bike_usage$avg_bikes_in_use[h + 1] = count_per_hour$avg_bikes
}

plot(hourly_bike_usage$hour, hourly_bike_usage$avg_bikes_in_use, type = "o", 
     main = "Average Number of Bikes in Use at Each Hour of the Day (May 2022 - Apr 2023)",
     xlab = "Hour of the Day", ylab = "Average Bikes in Use",
     xaxt = "n")
axis(1, at = 0:23) # Display hours from 0 to 23 on the x-axis
```

```{r}
data_by_bike = data %>% 
  group_by(bikeid, season) %>%
  dplyr::summarise(med_duration = median(tripduration))
data_by_bike
dim(data_by_bike)
boxplot(data_by_bike$med_duration)
```

#Bike usage by season

```{r by_season}
#QUESTION: IS IT RIGHT TO REPRESENT THIS AS A LINE GRAPH WHEN THE PATTERN IS CYCLICAL
seasonal_hourly_bikes = data %>%
  group_by(season, starthour) %>%
  dplyr::summarise(total_bikes_in_use = n(), .groups = "drop") # Corrected to count bikes in use

ggplot(seasonal_hourly_bikes, aes(x = starthour, y = total_bikes_in_use, color = season, group = season)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Total Rides Begun at Each Hour",
    x = "Time of Day",
    y = "Rides",
    color = "Season") +
  scale_x_continuous(
    breaks = seq(0, 23, by=4),
    labels = format(strptime(seq(0, 23, by=4), format = "%H"), "%I:%M %p") ) +
  scale_y_continuous(labels = label_comma()) + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
hours = 0:23
seasons = unique(data$season)

bikes_in_use_by_season = expand.grid(hour=hours, season=seasons)
bikes_in_use_by_season$bikes_in_use = 0

for (s in seasons) {
  for (h in hours) {
    count = data %>%
      filter(season == s, hour(starttime) <= h & hour(stoptime) >= h) %>%
      nrow()
    bikes_in_use_by_season$bikes_in_use[bikes_in_use_by_season$hour == h & bikes_in_use_by_season$season == s] = count
  }
}
```

```{r}
seasons = c('Fall', 'Spring', 'Summer', 'Winter')
ggplot(bikes_in_use_by_season, aes(x = hour, y = bikes_in_use, color = season, group = season)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Number of Bikes in Use at Each Hour by Season",
    x = "Time of Day",
    y = "Number of Bikes in Use",
    color = "Season"
  ) +
  scale_x_continuous(
    breaks = seq(0, 23, by = 4), 
    labels = format(strptime(seq(0, 23, by = 4), format = "%H"), "%I:%M %p")
  ) +
  scale_y_continuous(labels = label_comma()) +  # Format y-axis without scientific notation
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



```{r}
#QUESTIONS TO EXPLORE: COULD THE INCREASE IN RIDES OVER THE SUMMER BE ACCOUNTED FOR BY THE LATER NIGHT RIDES SEEN AFTER 8 PM?
# WHY IS THERE SUCH A SHARP DIP IN THE SUMMER FOR RIDES BEGUN BETWEEN 4 AM AND 11 AM? 
```

#Bike usage by day of week
```{r}
bikes_in_use_by_day = expand.grid(day=days())
bikes_in_use_by_season$bikes_in_use = 0

days = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")

data = data %>% mutate(day_of_week = wday(starttime, label = TRUE, abbr = FALSE))
bikes_in_use_by_day = expand.grid(day_of_week = days, season = seasons)
bikes_in_use_by_day$bikes_in_use = 0

for (s in seasons) {
  for (d in days) {
    count = data %>%
      filter(season == s, day_of_week == d) %>%
      nrow()
    bikes_in_use_by_day$bikes_in_use[bikes_in_use_by_day$day_of_week == d & bikes_in_use_by_day$season == s] = count
  } }
```

```{r}
season_colors <- brewer.pal(4, "Set1")
# Plot bike usage by day of the week and season (bar plot)
ggplot(bikes_in_use_by_day, aes(x = day_of_week, y = bikes_in_use, fill = season)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Bike Usage by Day of the Week and Season",
       x = "Day of the Week",
       y = "Bikes in Use") +
  scale_x_discrete(limits = c('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday')) +
  theme_minimal() +
  scale_fill_manual(values = season_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
#heatmap of day of week and season
season_colors = brewer.pal(4, "Set1")

ggplot(bikes_in_use_by_day, aes(x = day_of_week, y = season, fill = bikes_in_use)) +
  geom_tile() +  # Use tiles for heatmap
  labs(title = "Bike Usage by Day of the Week (Column Scaled)",
       x = "",
       y = "",
       fill = "Bikes in Use") +
  scale_x_discrete(limits = c('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday')) +
  scale_y_discrete(limits = c('Summer', 'Fall', 'Winter', 'Spring')) + 
  scale_fill_gradientn(colors = brewer.pal(9, "Reds")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
#base R heatmap
palette = colorRampPalette(brewer.pal(9, "Reds"))(100)
heatmap_data = reshape(bikes_in_use_by_day, 
                        idvar = "season", 
                        timevar = "day_of_week", 
                        direction = "wide")
sunday = heatmap_data[,2]
heatmap_data_ordered = cbind(heatmap_data[,-2], sunday)
colnames(heatmap_data) <- c("season", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", 'Sun')


rownames(heatmap_data) = heatmap_data$season
heatmap_matrix = as.matrix(heatmap_data[, -1])  
fall = heatmap_matrix[1,]
spring = heatmap_matrix[2,]
summer = heatmap_matrix[3,]
winter = heatmap_matrix[4,]

heat_mat = t(cbind(summer, fall, winter, spring))

# Create heatmap with row-wise scaling
heatmap(heatmap_matrix, 
        #scale = "row",
        Colv = NA,     
        Rowv = NA,    
        col = palette,
        main = "",
        cexRow = 0.8, 
        cexCol = 0.8,
        margins = c(8, 8))  
title("Bike Usage by Day of the Week (Row-Scaled)", cex.main = 1, adj = 0.3, line = 3) 
```
- summer thursdays and winter fridays frequently used, spring mondays and saturdays. winter weekdays
- reorder the seasons + legend
- more colours 

```{r}
#heatmap of day of week and time of day (morning, afternoon, evening)
ggplot(bikes_in_use_by_season, aes(x = hour, y = season, fill = bikes_in_use)) +
  geom_tile() +
  scale_fill_gradientn(colors = brewer.pal(9, "Blues")) +  
  labs(
    title = "Number of Bikes in Use at Each Hour by Season",
    x = "",
    y = "",
    fill = "Bikes in Use"
  ) +
  scale_x_continuous(
    breaks = seq(0, 23, by = 4), 
    labels = format(strptime(seq(0, 23, by = 4), format = "%H"), "%I:%M %p")
  ) +
  scale_y_discrete(limits = c('Fall', 'Spring', 'Summer', 'Winter')) +  # Order the seasons
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
- how useful is this versus the line plot? 
- fall highly used between 8 am and 8 pm as compared to other seasons
- spring higher use between 4 pm and 11 pm
- average sunrise. sunset

```{r}
#heatmap of day of week and time of day (morning, afternoon, evening)
ggplot(bikes_in_use_by_day, aes(x = hour, y = day_of_week, fill = bikes_in_use)) +
  geom_tile() +
  scale_fill_gradientn(colors = brewer.pal(9, "Blues")) +  
  labs(
    title = "Number of Bikes in Use at Each Hour by Season",
    x = "Time of Day",
    y = "Season",
    fill = "Bikes in Use"
  ) +
  scale_x_continuous(
    breaks = seq(0, 23, by = 4), 
    labels = format(strptime(seq(0, 23, by = 4), format = "%H"), "%I:%M %p")
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```

```{r}
#ridge line plot
ggplot(bikes_in_use_by_season, aes(x = bikes_in_use, y = season, fill = hour)) +
  geom_density_ridges(scale = 2, alpha = 0.7) + 
  scale_fill_gradient() + 
  labs(
    title = "Distribution of Bikes in Use by Hour and Season",
    x = "Number of Bikes in Use",
    y = "Season",
    fill = "Hour"
  ) +
  scale_x_continuous(labels = label_comma()) + 
  theme_ridges() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
# plotly zoomable plot of time? 
```

```{r}

```


##Mapping bikes across Boston
```{r}
#many NA values in the start station latitude and longitude
march13 = data %>%
  filter(starttime >= "2023-03-13 00:00:00" & starttime < "2023-03-14 00:00:00")
bikes_in_use = march13 %>%
  group_by(`start station name`, `start station latitude`, `start station longitude`) %>%
  dplyr::summarise(bikes_in_use = n(), med_duration = median(tripduration))
leaflet(bikes_in_use) %>%
  addTiles() %>%  
  setView(lng = -71.0589, lat = 42.3601, zoom = 12) %>%
  addCircleMarkers(
    lng = ~`start station longitude`, 
    lat = ~ `start station latitude`, 
    radius = ~(bikes_in_use/10),  
    popup = ~paste(
      "Station: ", `start station name`, 
      "<br>Bikes in use: ", bikes_in_use),
    color = ~ifelse(bikes_in_use > 20, "red", muted("red")),  
    fillOpacity = 0.6
  )
```

```{r}
#many NA values in the start station latitude and longitude
june30 = data %>%
  filter(starttime >= "2022-07-30 00:00:00" & starttime < "2022-08-1 00:00:00")
bikes_in_use = march13 %>%
  group_by(`start station name`, `start station latitude`, `start station longitude`) %>%
  dplyr::summarise(bikes_in_use = n(), med_duration = median(tripduration))
leaflet(bikes_in_use) %>%
  addTiles() %>%  
  setView(lng = -71.0589, lat = 42.3601, zoom = 12) %>%
  addCircleMarkers(
    lng = ~`start station longitude`, 
    lat = ~ `start station latitude`, 
    radius = ~(bikes_in_use/10),  
    popup = ~paste(
      "Station: ", `start station name`, 
      "<br>Bikes in use: ", bikes_in_use),
    color = ~ifelse(bikes_in_use > 20, "red", "blue"),  
    fillOpacity = 0.6
  )
```

```{r}
library(leaflet.extras)
library(shiny)

ui = fluidPage(
  titlePanel("Bike Usage Map with Time Slider"),
  sidebarLayout(
    sidebarPanel(
      sliderInput("timeSlider", 
                  "Select Date", 
                  min = min(data$startday), 
                  max = max(data$startday), 
                  value = min(data$startday), 
                  timeFormat = "%Y-%m-%d")),
    mainPanel(
      leafletOutput("bikeMap"))))

server = function(input, output, session) {
                  output$bikeMap <- renderLeaflet({
    data_filtered = data %>%
      filter(date == input$timeSlider)
    leaflet(data_filtered) %>%
      addTiles() %>%
      setView(lng = -71.0589, lat = 42.3601, zoom = 12) %>%
      addCircleMarkers(
        lng = ~`start station longitude`,
        lat = ~`start station latitude`,
        radius = ~(bikes_in_use/10) ,
        popup = ~paste("Station: ", `start station name`, "<br>Bikes in use: ", bikes_in_use),
        color = ~ifelse(bikes_in_use > 20, "red", muted("red")),
        fillOpacity = 0.6)})}

shinyApp(ui = ui, server = server)
```

##Modelling
```{r}
data$usertype <- factor(data$usertype)
data$day_of_week <- weekdays(data$starttime)
data_station_usage = data %>%
  group_by(`start station name`, startday) %>%
  dplyr::summarise(bikes_in_use = n())

data_station_usage <- data_station_usage %>%
  left_join(data %>%
              dplyr:::select(`start station name`, starttime, day_of_week, season, starthour, usertype),
            by = c("start station name", "starttime"))
```

#Tracking bike-level data
```{r}
by_bike_id = data %>% 
  group_by(bikeid) %>%
  dplyr::summarise(count = n(), first_used = min(starttime),
    last_used = max(stoptime), med_ride_duration = median(tripduration), 
    days_used = n_distinct(startday))
```

```{r}
#HOW LONG ARE BIKES TYPICALLY IN USE? HOW MUCH IS EACH BIKE USED?
par(mfrow = c(1, 2))
sinaplot(by_bike_id$count, col=alpha("lightblue1",.2))
hist(by_bike_id$count, main='Rides completed per bike May 22 - Apr 23', col='lightblue1', breaks = 50)
range(by_bike_id$count)
summary(by_bike_id$count)

by_bike_id$days_available = as.numeric(by_bike_id$last_used - by_bike_id$first_used) / 60 / 24
summary(by_bike_id$days_available)
sinaplot(by_bike_id$days_available, col=alpha("lightblue1",.2), main='Days Bikes are Available')

par(mfrow = c(1, 3))
sinaplot(by_bike_id$med_ride_duration, col=alpha("lightblue1",.2), ylab='Median Trip Duration')
hist(by_bike_id$med_ride_duration, col='lightblue1', breaks=50)
boxplot(by_bike_id$med_ride_duration)

by_bike_id$utilisation = by_bike_id$days_used/by_bike_id$days_available
hist(by_bike_id$utilisation[by_bike_id$utilisation <= 1], bins=c(0,1,0.01))
#how to visualise this? 
#since the days available is also defined using only the trips information, 
```
- hist versus sinaplot? 


#Modelling
```{r}
library(rpart)
library(rpart.plot)
library(forecast) #time series model
```

```{r}
data = data %>%
  mutate(
    hour = starttime,  
    day_of_week = wday(starttime, label = TRUE, abbr = FALSE), 
    season = factor(season, levels = c("Winter", "Spring", "Summer", "Fall")) 
  )

cart_model = rpart(
  bikes_in_use ~ hour + day_of_week + season + month + `start station name`,
  data = data,
  method = "anova",  
  control = rpart.control(minsplit = 20)  
)

# View the model
print(cart_model)

# Plot the tree
rpart.plot(cart_model, main = "CART Model for Predicting Bikes in Use")

# Make predictions
predictions = predict(cart_model, newdata = data)

# Check model performance (e.g., Mean Absolute Error)
mae = mean(abs(predictions - data$bikes_in_use))
print(paste("Mean Absolute Error: ", mae))
```
